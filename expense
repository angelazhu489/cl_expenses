#! /usr/bin/env ruby
require "pg"
require "Date"

class ExpenseData
	def initialize
		@db = PG.connect(dbname:"expenses")
	end

	def list_expenses
		table = @db.exec("SELECT * FROM expenses ORDER BY created_on;")
		table.each do |tuple|
			cols = ["#{tuple["id"].rjust(3)}", 
				"#{tuple["created_on"]}",
				"#{tuple["amount"].rjust(12)}",
				"#{tuple["memo"]}"]
			puts cols.join(" | ")
		end
	end
	
	def add_expense(amnt, memo)
		date = Date.today
		sql = "INSERT INTO expenses (amount, memo, created_on) VALUES ($1, $2, $3)"
		@db.exec_params(sql, [amnt, memo, date])
	end
end

class CLI
	def initialize
		@app = ExpenseData.new
	end

	def run(args)
		command = args[0]
		if command == "list"
			@app.list_expenses
		elsif command == "add"
			if args[1] && args[2]
				amount = args[1]
				memo = args[2]
				@app.add_expense(amount, memo)
			else
				puts "You must provide an amount and memo."
			end
		else 
			display_help
		end
	end

	def display_help
		puts <<~HELP 
			An expense recording system
	
			Commands:
	
			add AMOUNT MEMO - record a new expense
			clear - delete all expenses
			list - list all expenses
			delete NUMBER - remove expense with id NUMBER
			search QUERY - list expenses with a matching memo field
		HELP
	end 
end

CLI.new.run(ARGV)